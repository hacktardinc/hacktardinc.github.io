---

title: "2022-03-21 - TRAFFIC ANALYSIS EXERCISE - BURNINCANDLE"
date: 2022-11-15 01:09:33 +0300
author: oste
image: /assets/img/Posts/mt1.png
categories: [CTF-TIME]
tags:
  [
    Cobalt Strike,
    wireshark,
    kerberos,
    NetworkMiner,
    IcedID,
    samr,
    MS-SAMR,
    Quantum Ransomware,
  ]
---

# 2022-03-21 - TRAFFIC ANALYSIS EXERCISE - BURNINCANDLE

# SCENARIO

[Exercise Link](https://www.malware-traffic-analysis.net/2022/03/21/index3.html)

**Zip archive of the pcap: [2022-03-21-traffic-analysis-exercise.pcap.zip](https://www.malware-traffic-analysis.net/2022/03/21/2022-03-21-traffic-analysis-exercise.pcap.zip) 4.9 MB (4,942,730 bytes)**

## LAN segment data:

- LAN segment range: 10.0.19.0/24 (10.0.19.0 through 10.0.19.255)
- Domain: burnincandle.com
- Domain controller: 10.0.19.9 - BURNINCANDLE-DC
- LAN segment gateway: 10.0.19.1
- LAN segment broadcast address: 10.0.19.255

## TASK

- Write an incident report based on the pcap.
- The incident report should contains 3 sections:
  - Executive Summary: State in simple, direct terms what happened (when, who, what).
  - Details: Details of the victim (hostname, IP address, MAC address, Windows user account name).
  - Indicators of Compromise (IOCs): IP addresses, domains and URLs associated with the infection. SHA256 hashes if any malware binaries can be extracted from the pcap.

# 🧠 Thought Process 🧠

We have been provided details regarding the clients LAN segment to investigate what transpired. So far we have the Domain info, DC, Gateway and Broadcast IP addresses. A quick way to find other hosts on the network would be too look at the endpoint summary. ( _Statistics > Endpoints_)

![image](https://user-images.githubusercontent.com/58165365/195339628-e1cb117b-aa6a-4342-8f0d-e22a446f4439.png)

We get `10.0.19.14` , and judging by the number of packets, this could be the target we're interested in. Lets find more info about the host. Using `dhcp` as my display filter, and inspecting the `DHCP Request` frame in the packet details pane, we get information that we need. i.e,

- Client MAC address: **PERIPHER_b7:33:0f (00:60:52:b7:33:0f)**
- Requested IP Address: **10.0.19.14**
- Host Name: **DESKTOP-5QS3D5D**
- Client name: **DESKTOP-5QS3D5D.burnincandle.com**

![image](https://user-images.githubusercontent.com/58165365/195342077-00258704-c608-4f81-a314-337dfd38a47c.png)

We also need to find the User account name of this host. Since the IP is co-joined to a domain (burnincandle.com), we can confirm if we have some `kerberos` related packets by looking at the protocol hiererachy statistics.( _Statistics > Protocol Hiererachy_)

> _Kerberos is a protocol for authenticating service requests between trusted hosts across an untrusted network, such as the internet._

![image](https://user-images.githubusercontent.com/58165365/195350365-fd288f0e-e776-4a5a-bd42-82148991affb.png)

Yeeep, we do. With this in mind, since we know the DC ip, we can throw in a filter like `ip.addr == 10.0.19.14 && ip.addr == 10.0.19.9 && kerberos.CNameString and !(kerberos.CNameString contains $)` to only display packets containing the `CNameString` field.

![image](https://user-images.githubusercontent.com/58165365/195353566-21602bcc-bbf4-470b-8399-116309318140.png)

- cname: this section holds the username the client is trying to authenticate. To be more specific, the exact username in this case is “patrick.zimmerman”

> Please note that the `CNameString` Column isnt there by default. I added it manually as shown:

![image](https://user-images.githubusercontent.com/58165365/195352741-70846adf-5ccd-4d2f-b11a-13167ef842e5.png)

Also, another quick way to find such information, you can use [NetworkMiner](https://www.netresec.com/?page=NetworkMiner) , an open source Network Forensic Analysis Tool (NFAT).

![image](https://user-images.githubusercontent.com/58165365/195439127-d6cbe95b-fcff-44ed-8c87-51d90c7a86d8.png)

---

# IOC's

We can then start looking for any IOCs and try figure out what happened. Looking at HTTP related traffic, we see the victim machine made contact with a suspicious host : `oceriesfornot.top` on dst IP : `188.166.154.118`

![image](https://user-images.githubusercontent.com/58165365/195357527-353240da-80bf-418a-8a8c-2a1bbb3f480f.png)

I did a lookup on the two hosts : `x1.c.lencr.org` & `ctldl.windowsupdate.com` and they seem to legitimately belong to LetsEncrypt & Microsoft respectively. However, `oceriesfornot.top` looks like its affliated to the `Quantum Ransomware`

![image](https://user-images.githubusercontent.com/58165365/195358526-5bfa77e7-894b-4f7d-9945-81da84b4e143.png)

Selecting the frame and following TCP stream, we get an interesting cookie :

![image](https://user-images.githubusercontent.com/58165365/195390352-6cf335e0-7ee2-4a6d-aabf-e92b85449fab.png)

Spent sometime researching more on the same and got a hit on [sysopfb's](https://sysopfb.github.io/malware,/icedid/2020/04/28/IcedIDs-updated-photoloader.html) blog where he does some RE on `IcedID malware` that contained a similar cookie.

He explains that the `_u` cookie value holds the victims username and computername hexlified. So i used cyberchef to confirm this and indeed we get: `DESKTOP-5QS3D5D:patrick.zimmerman:CD2F3B9F67E3C343`

Other values have been summarized in the table below:

| Cookie | Value                                                                                                                                                      |
| ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| \_gid  | Based on physical address of NIC                                                                                                                           |
| \_io   | Domain identifier from SID                                                                                                                                 |
| \_u    | Username and Computername                                                                                                                                  |
| \_gat  | Windows version info                                                                                                                                       |
| \_ga   | Processor info via CPUID including hypervisor brand if available                                                                                           |
| \_gads | First DWORD from decoded config data, flag from inspecting server certificate, a random DWORD or number passed as parameter with -id=, number of processes |

Something else we notice here is the victim seems to be getting a gzip file from the suspicious IP. I used NetworkMiner to extract it.

![image](https://user-images.githubusercontent.com/58165365/195395040-7cbf7b3f-fc09-4498-978c-3d9eb2515e23.png)

However, [VT](https://www.virustotal.com/gui/file/ac64292e91738bf97842e7e5d28373a3a52bdb0aa2bc48a0df512e34d1b41501/detection) didnt pick this up as malicious.

I tried to do some manual analysis on the file and see what i could find but i guess i hit the wall 😩. Back to research , i found out that `IcedID` uses this technique as the first stage loading mechanism. The [Binary Defense Threat Hunting team](https://www.binarydefense.com/icedid-gziploader-analysis/) have a nice technical blog on the _IcedID GZIPLOADER_ . i'd suggest having a look at it.😉

![image](https://user-images.githubusercontent.com/58165365/195401423-125ec0c6-103f-4d37-a997-411ce874ce5e.png)

Simply put, IcedID’s gziploader infection chain looks like this:

![image](https://user-images.githubusercontent.com/58165365/195403053-dc1fda9a-0676-4e1a-b34f-759e8a7d8755.png)

~Source: _Binary Defense Blog_

I then proceeded to my third tool, `Brim Security` to query the packets further. In this case i'm interested in seeing DNS queries with the most counts or suspicious names.

![image](https://user-images.githubusercontent.com/58165365/195419213-d9acea65-353a-45e6-b5bd-10d4cdcc4e58.png)
![image](https://user-images.githubusercontent.com/58165365/195419644-4305b230-c6bb-4292-a94f-33d18579177c.png)

Cleaning this up abit we get the queries and responses.

![image](https://user-images.githubusercontent.com/58165365/195435140-0f3ea76b-c3b3-4c50-921e-ee689bb4e63b.png)

Now back to wireshark and filtering for `dns.a` we get 3 other unique query responses, 2 happening in a span of a second. Whats also unique is that both are file sharing websites.

![image](https://user-images.githubusercontent.com/58165365/195444747-d73a1e49-862b-4326-9787-a7c8d7e08f8d.png)

Applying `23.227.198.203` (bupdater.com) as my destination address, i noticed a pattern. Every minute the host seems to beacon/communicate with bupdater[.]com on port 757. C2 traffic? Potential exfiltration? C2 heartbeat activity? Lets find out.

![image](https://user-images.githubusercontent.com/58165365/195450647-8ddd6503-ec20-45a7-9707-9e15f302f7c4.png)

Doing a lookup on [VirusTotal](https://www.virustotal.com/gui/domain/bupdater.com/community) , i found several other people having reported it as a Cobalt Strike C2 Server.

![image](https://user-images.githubusercontent.com/58165365/195457291-1a8922b5-c06a-4cd4-8333-5d4e896b39c4.png)

![image](https://user-images.githubusercontent.com/58165365/195457329-a783d45e-64c3-4edf-981c-7c8094aee074.png)

# Enumeration.

Net (net.exe) commands are often used by attackers and insiders to enumerate target network information, change passwords, and create users. Monitoring for [MS-SAMR](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/4df07fab-1bbc-452f-8e92-7853a3c7e380) related activities, allows us to detect and respond to this behavior that is often an important part of attacks such as ransomware.

> _MS-SAMR (Security Account Manager (SAM) Remote Protocol) supports management functionality for an account store or directory containing users and groups. The goal of the protocol is to enable IT administrators and users to manage users, groups, and computers._

On wireshark, we can filter for this protocol by using `samr` as our display filter. But for learning purposes, lets first understand the basic flow of the SAMR protocol. (_See screenshot below_)

![image](https://user-images.githubusercontent.com/58165365/195845193-26035100-bd74-4550-b031-550409730363.png)

- 1. Shortly after our victim is done communicating with `157.245.142.66` , we can see SMB connections from the victim to the DC.
- 2. The second phase is to connect to the IPC$ share on the remote machine. The IPC$ share as you might already know, is used for Inter Proces Communication by using RPC over SMB to allow clients to send different commands to the server to listen users, shares, etc.
- 3. The third phase is to open the SAMR named pipe.
- 4. Fourth phase is to connect to the SAMR interface, which can be recognized by its UUID: `12345778-1234-abcd-ef00-0123456789ac` as shown below.

![image](https://user-images.githubusercontent.com/58165365/195846256-46e30892-285e-44de-8365-d3760c0338a7.png)

Just to make things cleaner moving on, i applied the `samr` filter to get commands and queries executed. The first two packets, `Connect5 request` & `Connect5 response` tends to obtains a handle to a server object. What follows next is abit interesting though.

![image](https://user-images.githubusercontent.com/58165365/195847652-a7c574d4-e25d-4913-afe9-01503495609d.png)

The attacker seems to be enumerating the Domain, Groups, RIDS etc. Here is a summary of all methods i extracted at the end of my analysis:

- EnumDomains - is used to obtain a listing of all domains hosted by the server-side of the protocol.
- LookupDomain - uses the established context handle to return the SID of a domain object, given the object’s name obtained from the _EnumerateDomains_ method.
- OpenDomain - obtains a handle to a domain object, using the SID returned by the previous _LookupDomain_ method.
- LookupNames - translates a set of account names into a set of RIDs.
- OpenGroup - obtains a handle to a domain object, given a SID.
- QueryGroupInfo
- QueryGroupMember - will query all the members that are part of Domain Admin but will only display the RID.
- LookupRids - Shows the account name of each RID that is a member of Domain Admins.
- OpenUser - obtains a handle to a user, given a RID.
- QueryUserInfo - obtains attributes from a user object using the user object handle
- QuerySecurity
- GetGroupsForUser - obtains a listing of groups that a user is a member of.
- GetAliasMembership - obtains the union of all aliases that a given set of SIDs is a member of.

Sample information gathered about the target and target domain:

![image](https://user-images.githubusercontent.com/58165365/195853343-d7f678d2-82c5-4ad8-92a2-88e3f1e5e6c9.png)

![image](https://user-images.githubusercontent.com/58165365/195852603-d50a7a81-1f10-422d-b006-fb8af80ad7ea.png)

![image](https://user-images.githubusercontent.com/58165365/195852796-cd55a052-4878-4494-8958-8862c77a4d89.png)

---

Summary of IOC's collected:

### Domains and IP addresses for IcedID (Bokbot):

| Domain                | IP              |
| --------------------- | --------------- |
| oceriesfornot[.]top   | 188.166.154.118 |
| antnosience[.]com     | 157.245.142.66  |
| suncoastpinball[.]com | 160.153.32.99   |
| otectagain[.]top      | 157.245.142.66  |
| seaskysafe[.]com      | 91.193.16.181   |
| dilimoretast[.]com    | 160.153.32.99   |

### Suspicious traffic to file sharing domains:

| Domain                | IP                        |
| --------------------- | ------------------------- |
| filebin[.]net         | 185.47.40.36              |
| situla[.]bitbit[.]net | 87.238.33.8 , 87.238.33.7 |

### Domains and IP addresses for Cobalt Strike:

| Domain         | IP             | Port |
| -------------- | -------------- | ---- |
| bupdater[.]com | 23.227.198.203 | 757  |

# Conclusion

I had so much fun analyzing this PCAP, and learnt much on the fly. I would definately recommend checking out [Brad Duncan's Blog](https://www.malware-traffic-analysis.net/). It's really a great resource for packet capture (pcap) files and malware samples. While you are at it, consider giving him a follow on twitter [@malware_traffic](https://twitter.com/malware_traffic) for any updates.

![image](https://user-images.githubusercontent.com/58165365/202019572-82db57c9-6f45-4e19-b6f0-782bd9fc02c0.png)

If anyone has additional details that i might have missed, or has any feedback to improve my methodology it would be greatly appreciated.

# Resources

- [Wireshark Tutorial: Identifying Hosts and Users](https://unit42.paloaltonetworks.com/using-wireshark-identifying-hosts-and-users/)
- [Taming Kerberos and making it our loyal companion](https://blog.notso.pro/2020-05-07-offops-in-ad-0/)
- [IcedID PhotoLoader evolution](https://sysopfb.github.io/malware,/icedid/2020/04/28/IcedIDs-updated-photoloader.html)
- [IcedID GZIPLOADER Analysis](https://www.binarydefense.com/icedid-gziploader-analysis/)
- [MS-SAMR: Security Account Manager (SAM) Remote Protocol (Client-to-Server) doumentation](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/4df07fab-1bbc-452f-8e92-7853a3c7e380)
- [Detecting Security Events Using the MS-SAMR Protocol](https://aristanetworks.force.com/AristaCommunity/s/article/Detecting-Security-Events-Using-the-MS-SAMR-Protocol)
- [Analyzing network packets with Wireshark – AD and User Enumeration](https://m365internals.com/2022/06/19/how-do-i-approach-a-technical-topic-packet-capture-part-1/)
